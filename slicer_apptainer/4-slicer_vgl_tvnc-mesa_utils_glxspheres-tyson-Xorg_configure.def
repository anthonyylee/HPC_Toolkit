Bootstrap: docker
From: ubuntu:22.04

%post
    apt-get update && apt-get install -y \
	vim \
	xfce4 \
        wget ca-certificates unzip \
        libglu1-mesa libpulse-mainloop-glib0 libnss3 \
        libasound2 libsm6 libice6 qt5dxcb-plugin\
        libx11-6 libx11-xcb1 libxcb1 libxcb-icccm4 \
        libxkbcommon0 libxkbcommon-x11-0 \
        libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 \
        libxcb-shape0 libxcb-sync1 libxcb-xfixes0 libxcb-xinerama0 \
        libxt6 libxrender1 libxext6 libxcomposite1 libxdamage1 \
        libxrandr2 libxkbfile1 libfreetype6 libfontconfig1 \
        libgl1-mesa-glx libgl1-mesa-dri mesa-utils \

    # Configure XFCE
    #export DISPLAY=:1
    #xfconf-query -c xfce4-screensaver -p /lock/enabled -s false

    # Install Nvidia drivers â€” To get nvidia-xconfig
    #add-apt-respository ppa:graphics-drivers/ppa && apt update
    #apt install -y nvidia-driver-580
    #nvidia-xconfig

    # Install Nvidia drivers - non-specific method
    #add-apt-respository ppa:graphics-drivers/ppa && apt update
    #apt install -y nvidia-driver  # NOT SURE WHY THIS IS NOT FOUND

    # Setup Xorg configure for virtualgl
    /usr/bin/Xorg -configure -configdir /etc/X11/

    # Install VirtualGL
    #cd $HOME
    #wget -O virtualgl.deb "https://github.com/VirtualGL/virtualgl/releases/download/3.1.4/virtualgl_3.1.4_amd64.deb"
    #apt install -y ./virtualgl.deb
    #rm -rf virtualgl.deb

    # Install VirtualGL - https://virtualgl.org/Downloads/YUM
    apt install -y gnupg
    wget -q -O- https://packagecloud.io/dcommander/virtualgl/gpgkey | \
        gpg --dearmor >/etc/apt/trusted.gpg.d/VirtualGL.gpg
    wget -P /etc/apt/sources.list.d https://raw.githubusercontent.com/VirtualGL/repo/main/VirtualGL.list
    apt update
    apt install -y virtualgl

    # Install TurboVNC
    wget -q -O- https://packagecloud.io/dcommander/turbovnc/gpgkey | \
        gpg --dearmor >/etc/apt/trusted.gpg.d/TurboVNC.gpg
    wget -P /etc/apt/sources.list.d https://raw.githubusercontent.com/TurboVNC/repo/main/TurboVNC.list
    apt update
    apt install -y turbovnc

    # Install 3D Slicer
    mkdir -p /opt/slicer
    cd /opt/slicer
    wget -O Slicer-5.10.0.tar.gz "https://download.slicer.org/bitstream/6911b598ac7b1c95e7934427"
    tar -zxvf Slicer-5.10.0.tar.gz
    mv Slicer-*/* .
    rm -rf Slicer-* Slicer-5.10.0.tar.gz
    chmod +x /opt/slicer/Slicer

    # Configure VirtualGL for GLX backend
    #service lightdm stop
    #/opt/VirtualGL/bin/vglserver_config -config +s +f +t
    #/opt/VirtualGL/bin/vglserver_config -config +egl
    /opt/VirtualGL/bin/vglserver_config -config +s +f +t +egl

    # Set VNC password
    # https://askubuntu.com/questions/328240/assign-vnc-password-using-script
    export PATH=/opt/TurboVNC/bin:$PATH
    myvncpasswd="12345678"
    mkdir $HOME/.vnc
    echo $myvncpasswd | vncpasswd -f > $HOME/.vnc/passwd
    chmod 0600 $HOME/.vnc/passwd

%environment
    # Add Slicer libs and binaries to environment
    export PATH=/usr/bin:$PATH
    export SLICER_HOME="/opt/slicer"
    export PATH=/opt/slicer/bin:$PATH
    export PATH=/opt/TurboVNC/bin:$PATH
    export PATH=/opt/VirtualGL/bin:$PATH
    export LD_LIBRARY_PATH="/lib"
    export PATH=$SLICER_HOME:$LD_LIBRARY_PATH:$PATH
    export DISPLAY=:1

%runscript
    exec vncserver
    exec vglrun Slicer "$@"
